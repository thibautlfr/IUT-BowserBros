<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">
        <div class="block-buttons">
            <button class="block-button" data-type="0" style="background-image: url('Images/chest.png')"></button>
            <button class="block-button" data-type="1" style="background-image: url('Images/block1.jpg')"></button>
            <button class="block-button" data-type="2" style="background-image: url('Images/block5.jpg')"></button>
            <button class="block-button" data-type="3" style="background-image: url('Images/block3.jpg')"></button>
            <button class="block-button" data-type="4" style="background-image: url('Images/block2.jpg')"></button>
            <button class="block-button" data-type="5" style="background-image: url('Images/block6.jpg')"></button>
            <button class="block-button" data-type="6" style="background-image: url('Images/block4.jpg')"></button>
            <button class="block-button" data-type="11" style="background-image: url('Images/goomba.png')"></button>
            <button class="block-button" data-type="12" style="background-image: url('Images/koopa.png')"></button>
        </div>
        <div id="gridContainer">
            <div id="grid"></div>
        </div>
        <div class="controls">
            <div class="mousehelp">
                <img src="./Images/rightclick.png" alt="Mode Gomme">
                <p>Erase</p>
                <img src="./Images/leftclick.png" alt="Mode Crayon">
                <p>Draw</p>
            </div>

            <button id="clearButton">Effacer tout</button>
            <button id="export">Exporter</button>

            <button id="load">Charger</button>
            <input type="file" id="file" style="display: none;">
        </div>
    </div>
    <script>
        const gridWidth = 40;
        const gridHeight = 60;
        const grid = document.getElementById('grid');
        const blockType = document.getElementById('blockType');
        const clearButton = document.getElementById('clearButton');
        const exportButton = document.getElementById('export');

        const map = [];
        let mode = 'pencil';
        let isMouseDown = false;
        let chestPlaced = false;
        let selectedBlockType;

        const blockButtons = document.querySelectorAll('.block-button');

        // Ajouter ce code au début de votre script
        const fileInput = document.getElementById('file');
        const loadButton = document.getElementById('load');


        blockButtons.forEach(button => {
            button.addEventListener('click', () => {
                blockButtons.forEach(b => b.classList.remove('block-button-selected')); // retire la classe 'block-button-selected' des autres boutons
                button.classList.add('block-button-selected'); // ajoute la classe 'block-button-selected' au bouton cliqué
                selectedBlockType = button.dataset.type;
                mode = 'pencil';
            });
        });

        clearButton.addEventListener('click', () => {
            map.length = 0;
            chestPlaced = false;
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.style.backgroundImage = '';
                cell.dataset.type = '';
            });
        });

        for (let i = 0; i < gridHeight; i++) {
            for (let j = 0; j < gridWidth; j++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.x = j;
                cell.dataset.y = i;
                if (i === gridHeight - 1) {
                    cell.classList.add('unusable');
                    cell.style.pointerEvents = 'none';
                }
                if (i === gridHeight - 2) {
                    cell.classList.add('ground');
                }
                cell.addEventListener('mousedown', (event) => {
                    isMouseDown = true;
                    if (event.button == 0) { // 0 corresponds to the left mouse button
                        mode = 'pencil';
                    } else if (event.button == 2) { // 2 corresponds to the right mouse button
                        mode = 'eraser';
                    }
                    handleCellClick(cell);
                });

                cell.addEventListener('contextmenu', (event) => {
                    event.preventDefault();
                    isMouseDown = true;
                    mode = 'eraser';
                    handleCellClick(cell);
                });

                cell.addEventListener('mouseenter', () => {
                    if (isMouseDown) {
                        handleCellClick(cell);
                    }
                });

                cell.addEventListener('mouseup', () => {
                    isMouseDown = false;
                });

                grid.appendChild(cell);
            }
        }

        exportButton.addEventListener('click', () => {
            const modifiedMap = map.map(block => {
                const [x, y, type] = block.split(';');
                // Modification de l'ajout en y en fonction du type de bloc
                let newY;
                if (type === '11') { // Goomba
                    newY = parseInt(y) + 25;
                } else if (type === '12') { // Koopa
                    newY = parseInt(y) + 35;
                } else {
                    newY = parseInt(y) + 20;
                }
                return `${x};${newY};${type}`;
            });
            const text = modifiedMap.join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'level.txt';
            a.click();
        });



        function handleCellClick(cell) {
            // Trouver et supprimer tous les blocs existants qui correspondent à cette cellule
            let index;
            while ((index = map.findIndex(block => block.split(';')[0] == cell.dataset.x * 20 && block.split(';')[1] == (gridHeight - cell.dataset.y - 1) * 20)) > -1) {
                map.splice(index, 1);
            }

            if (mode === 'pencil') {
                if (selectedBlockType === '0' && chestPlaced) {
                    return;
                }

                cell.style.backgroundImage = `url(${getBlockImageUrl(selectedBlockType)})`;
                cell.dataset.type = selectedBlockType;
                map.push(`${cell.dataset.x * 20};${(gridHeight - cell.dataset.y - 1) * 20};${selectedBlockType}`);
                if (selectedBlockType === '0') {
                    chestPlaced = true;
                }
            } else if (mode === 'eraser') {
                if (cell.dataset.type === '0') {
                    chestPlaced = false;
                }
                cell.style.backgroundImage = '';
                cell.dataset.type = '';
            }
        }

        loadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                const lines = e.target.result.split('\n');
                lines.forEach(line => {
                    const [x, y, type] = line.split(';');

                    // Modification de y en fonction du type de bloc
                    let newY;
                    if (type === '11') { // Goomba
                        newY = parseInt(y) - 5;
                    } else if (type === '12') { // Koopa
                        newY = parseInt(y) - 15;
                    } else {
                        newY = parseInt(y);
                    }

                    const cell = document.querySelector(`.cell[data-x="${x / 20}"][data-y="${gridHeight - newY / 20}"]`);
                    if (cell) {
                        cell.style.backgroundImage = `url(${getBlockImageUrl(type)})`;
                        cell.dataset.type = type;
                        map.push(`${x};${newY};${type}`);
                        if (type === '0') {
                            chestPlaced = true;
                        }
                    }
                });
            };
            reader.readAsText(file);
        });



        function getBlockImageUrl(type) {
            if (type === '0') {
                return 'Images/chest.png';
            } else if (type === '1') {
                return 'Images/block1.jpg';
            } else if (type === '2') {
                return 'Images/block5.jpg';
            } else if (type === '3') {
                return 'Images/block3.jpg';
            } else if (type === '4') {
                return 'Images/block2.jpg';
            } else if (type === '5') {
                return 'Images/block6.jpg';
            } else if (type === '6') {
                return 'Images/block4.jpg';
            } else if (type === '11') {
                return 'Images/goomba.png';
            } else if (type === '12') {
                return 'Images/koopa.png';
            }
            return '';

        }
    </script>
</body>

</html>